# Цель
Преобразование исходных кодов 1С:Предприятие в файлы поставки при использовании практики Непрерывной интеграции
# Задачи
1. Прогон исходных кодов 1С: Предприятие по сборочной линии. Этапы сборочной линии:
  * Создание ИБ из исходников конфигурации и расширений. В сборке может участвовать до трех расширений
  * Выполнение модульных тестов
  * Формирование файлов поставки конфигурации и расширений
2. По результатам проверок формируется журнал
3. Этапы сборки выполняются для любого проекта и в любом окружении без изменения скриптов. Все настройки под конкретный проект и окружение выполняются в одном месте

# Настройки
Для настройки запуска скриптов под конкретный проект используется объект настроек сохраненный в settings.json. Все пути к файлам указываются относительно корня репозитория. Свойство объекта настроек:
* EDT_ProjectDir - строка с относительным путем к каталогу с проектом конфигурации
* Extensions - массив объектов с описанием всех расширений репозитория. Объект с описанием расширения содержит свойства:
  * name - строка с именем расширения
  * EDT_ProjectDir - строка с относительным путем к каталогу с проектом расширения
* JobsTimeout - число секунд ожидания фонового задания Powershell . Используется для запуска параллельных задач при конвертации исходников
* UnitTests - объект настройками раннера модульных тестов. Содержит свойства:
  * Config - строка с относительным путем к файлу конфигурации раннера
  * Extension - строка с именем расширения, содержашего модульные тесты
* Build - объект с настройками сборки артефактов. Свойства объекта:
  * Extensions - массив строк с именами расширений, которые будут выгружаться при завершении сборочной линии



# Как подготовить набор скриптов к запуску

# Список скриптов
* build/SetPathTo1c.ps1 - каталог исполняемых файлов платформы 1С добавляет в переменную среды PATH
* build/create-db.ps1 - из исходников создает ИБ 1С в каталоге "/.db". Также в эту ИБ из исходников загружаются расширения. Некоторые операции выполняются параллельно с помощью PowerShell background jobs. Для конвертации исходников используется 1cedtcli, для импорта в ИБ - ibcmd.
* build/test.ps1 - запускает модульные тесты для ИБ /.db с помощью раннера YAxUnit.
* build/dump-cfg.ps1 - выгружает из ИБ .db конфигурацию в каталог "/dist" в файл 1cv8.cf. Также из ИБ выгружаются расширения в файлы *.cfe . Выгружаются те расширения, которые заданы в массиве Build.Extensions настроек

Загрузка исходников конфигурации и расширений в ИБ происходит в два этапа:
1. Конвертация исходников в формат понятный конфигуратору с помощью EDT
2. Загрузка сконвертированных исходников в пустую ИБ с помощью конфигуратора.

# Пример использования на серверере сборок
Допустим есть вот такой репозиторий:
``` cmd
>dir /b
settings.json 
.gitattributes
.gitignore
build
README.md
src/TradeManagement
src/TradeManagement.FuncTests
src/TradeManagement.PatchCRM
src/TradeManagement.UnitTests
```
И при разработке используется платформа 1С версии 8.3.14. 

Тогда настройки скриптов для использования будут выглядеть вот так:
``` json
{
    "EDT_ProjectDir": "src/TradeManagement",
	"Extensions": [{"name": "FuncTests", "EDT_ProjectDir": "src/TradeManagement.FuncTests"}, 
	{"name": "Тесты", "EDT_ProjectDir": "src/TradeManagement.UnitTests"},
	{"name": "PatchCRM", "EDT_ProjectDir": "src/TradeManagement.PatchCRM"}],
	"JobsTimeout": 3600,
	"UnitTests": {
		"Config": "./test/unit/test-config.json",
		"Extension": "Тесты"
	},
	"Build":{
		"Extensions": ["FuncTests", "PatchCRM"]
	}
}

```
И инициализация версии 1С будет выполнятся вот так:
``` cmd
>build/SetPathTo1c.ps1
```
И сборка исходников в ИБ будет выполнятся вот так:
``` cmd
>build/create-db.ps1
```
И выполнение модульных тестов будет выполнятся вот так:
``` cmd
>build/test.ps1
```

# Использования на компьютере разработчика
На компьютере разработчика можно использовать вспомогательные скрипты запуска частых операций, расположенные в корне репозитория: 
* тут будут скрипты


# Пример использования на сервере сборок
Приведены примеры описания сборочных линий для Gitlab Pipelines. Линии используются в рамках процесса разработки по GitFlow: 
* тут будут пайплайны Gitlab
